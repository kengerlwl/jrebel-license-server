<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂêéÂè∞ÁÆ°ÁêÜ - JRebel License Server</title>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="/static/favicon.ico" type="image/x-icon">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.ico">
    <link rel="apple-touch-icon" href="/static/apple-touch-icon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --bg-body: #f8f9fa;
            --bg-card: #ffffff;
            --border-color: #e9ecef;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --accent-blue: #0d6efd;
            --accent-green: #198754;
            --accent-orange: #fd7e14;
            --accent-red: #dc3545;
            --shadow-sm: 0 .125rem .25rem rgba(0,0,0,.075);
            --shadow-md: 0 .5rem 1rem rgba(0,0,0,.15);
        }
        
        body {
            background: var(--bg-body);
            color: var(--text-primary);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        .navbar {
            background: var(--bg-card) !important;
            box-shadow: var(--shadow-sm);
        }
        
        .card {
            background: var(--bg-card);
            border: none;
            border-radius: 16px;
            box-shadow: var(--shadow-sm);
        }
        
        .card-header {
            background: transparent;
            border-bottom: 1px solid var(--border-color);
            padding: 1.25rem 1.5rem;
        }

        .card-body {
            padding: 1.5rem;
        }
        
        .stat-card {
            text-align: center;
            padding: 1.5rem;
        }
        
        .stat-card .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
        }
        
        .stat-card .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        
        .stat-card .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .table {
            margin-bottom: 0;
        }
        
        .table th {
            border-top: none;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .table td {
            vertical-align: middle;
            padding: 1rem 0.75rem;
        }
        
        .badge-product {
            padding: 0.35rem 0.65rem;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.75rem;
        }
        
        .badge-jrebel {
            background: rgba(253, 126, 20, 0.1);
            color: #fd7e14;
        }
        
        .badge-jetbrains {
            background: rgba(13, 110, 253, 0.1);
            color: #0d6efd;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 500;
        }
        
        .btn-sm {
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
        }

        .btn-primary {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
        }
        
        .form-control {
            border-radius: 8px;
            padding: 0.625rem 1rem;
        }
        
        .form-control:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
        }
        
        .pagination {
            margin-bottom: 0;
        }
        
        .page-link {
            border-radius: 8px;
            margin: 0 2px;
            border: none;
            color: var(--text-primary);
        }
        
        .page-item.active .page-link {
            background: var(--accent-blue);
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
        }
        
        .text-mono {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.875rem;
        }
        
        .truncate {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body>
    <!-- ÁôªÂΩïÈ°µÈù¢ -->
    <div id="loginPage" class="login-container">
        <div class="card">
            <div class="card-body p-4">
                <div class="text-center mb-4">
                    <i class="bi bi-shield-lock text-primary" style="font-size: 3rem;"></i>
                    <h4 class="mt-3">ÂêéÂè∞ÁÆ°ÁêÜ</h4>
                    <p class="text-muted small">ËØ∑ËæìÂÖ•ËÆøÈóÆ‰ª§Áâå</p>
                </div>
                <form id="loginForm">
                    <div class="mb-3">
                        <label class="form-label">Token</label>
                        <input type="password" class="form-control" id="tokenInput" placeholder="ËØ∑ËæìÂÖ• API Token" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-box-arrow-in-right"></i> ÁôªÂΩï
                    </button>
                </form>
                <div class="text-center mt-3">
                    <a href="/" class="text-muted small">
                        <i class="bi bi-arrow-left"></i> ËøîÂõûÈ¶ñÈ°µ
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- ÁÆ°ÁêÜÈ°µÈù¢ -->
    <div id="adminPage" style="display: none;">
        <nav class="navbar navbar-light">
            <div class="container-fluid">
                <a class="navbar-brand" href="/">
                    <i class="bi bi-lightning-charge-fill text-primary"></i>
                    JRebel License Server
                </a>
                <div class="d-flex align-items-center gap-3">
                    <span class="badge bg-primary">
                        <i class="bi bi-person-circle"></i> ÁÆ°ÁêÜÂëò
                    </span>
                    <button class="btn btn-outline-secondary btn-sm" onclick="logout()">
                        <i class="bi bi-box-arrow-right"></i> ÈÄÄÂá∫
                    </button>
                </div>
            </div>
        </nav>

        <div class="container-fluid py-4">
            <!-- ÁªüËÆ°Âç°Áâá -->
            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <div class="card stat-card">
                        <div class="stat-icon text-primary">
                            <i class="bi bi-graph-up"></i>
                        </div>
                        <div class="stat-value" id="totalCount">0</div>
                        <div class="stat-label">ÊÄª‰ΩøÁî®Ê¨°Êï∞</div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card stat-card">
                        <div class="stat-icon text-success">
                            <i class="bi bi-calendar-check"></i>
                        </div>
                        <div class="stat-value" id="todayCount">0</div>
                        <div class="stat-label">‰ªäÊó•‰ΩøÁî®</div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card stat-card">
                        <div class="stat-icon text-warning">
                            <i class="bi bi-fire"></i>
                        </div>
                        <div class="stat-value" id="jrebelCount">0</div>
                        <div class="stat-label">JRebel ÊøÄÊ¥ª</div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card stat-card">
                        <div class="stat-icon text-info">
                            <i class="bi bi-lightbulb"></i>
                        </div>
                        <div class="stat-value" id="jetbrainsCount">0</div>
                        <div class="stat-label">JetBrains ÊøÄÊ¥ª</div>
                    </div>
                </div>
            </div>

            <!-- ‰ΩøÁî®ËÆ∞ÂΩï -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history"></i> ‰ΩøÁî®ËÆ∞ÂΩï
                    </h5>
                    <div class="d-flex gap-2">
                        <div class="input-group" style="width: 300px;">
                            <input type="text" class="form-control" id="searchInput" placeholder="ÊêúÁ¥¢ GUID Êàñ IP...">
                            <button class="btn btn-outline-secondary" type="button" onclick="searchRecords()">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                        <button class="btn btn-outline-primary" onclick="refreshRecords()">
                            <i class="bi bi-arrow-clockwise"></i> Âà∑Êñ∞
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Êó∂Èó¥</th>
                                    <th>‰∫ßÂìÅ</th>
                                    <th>GUID</th>
                                    <th>Áî®Êà∑Âêç</th>
                                    <th>IP Âú∞ÂùÄ</th>
                                    <th>Êìç‰ΩúÁ±ªÂûã</th>
                                </tr>
                            </thead>
                            <tbody id="recordsTable">
                                <!-- Âä®ÊÄÅÂä†ËΩΩ -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Á©∫Áä∂ÊÄÅ -->
                    <div class="empty-state" id="emptyState" style="display: none;">
                        <i class="bi bi-inbox"></i>
                        <p>ÊöÇÊó†‰ΩøÁî®ËÆ∞ÂΩï</p>
                    </div>
                </div>
                
                <!-- ÂàÜÈ°µ -->
                <div class="card-footer bg-transparent d-flex justify-content-between align-items-center">
                    <div class="text-muted small">
                        ÂÖ± <span id="totalRecords">0</span> Êù°ËÆ∞ÂΩï
                    </div>
                    <nav>
                        <ul class="pagination" id="pagination">
                            <!-- Âä®ÊÄÅÁîüÊàê -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let token = localStorage.getItem('admin_token') || '';
        let currentPage = 1;
        const pageSize = 20;
        
        // Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅ
        function checkAuth() {
            if (token) {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('adminPage').style.display = 'block';
                loadStats();
                loadRecords();
            } else {
                document.getElementById('loginPage').style.display = 'block';
                document.getElementById('adminPage').style.display = 'none';
            }
        }
        
        // ÁôªÂΩï
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const inputToken = document.getElementById('tokenInput').value.trim();
            
            if (!inputToken) {
                alert('ËØ∑ËæìÂÖ• Token');
                return;
            }
            
            // È™åËØÅ token
            try {
                const response = await fetch('/api/admin/stats', {
                    headers: {
                        'Authorization': `Bearer ${inputToken}`
                    }
                });
                
                if (response.ok) {
                    token = inputToken;
                    localStorage.setItem('admin_token', token);
                    checkAuth();
                } else {
                    alert('Token Êó†ÊïàÔºåËØ∑ÈáçËØï');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('È™åËØÅÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        });
        
        // ÈÄÄÂá∫
        function logout() {
            token = '';
            localStorage.removeItem('admin_token');
            checkAuth();
        }
        
        // Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆ
        async function loadStats() {
            try {
                const response = await fetch('/api/admin/stats', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('totalCount').textContent = data.total || 0;
                    document.getElementById('todayCount').textContent = data.today || 0;
                    document.getElementById('jrebelCount').textContent = data.jrebel || 0;
                    document.getElementById('jetbrainsCount').textContent = data.jetbrains || 0;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        // Âä†ËΩΩËÆ∞ÂΩï
        async function loadRecords(page = 1, search = '') {
            currentPage = page;
            
            try {
                let url = `/api/admin/records?page=${page}&page_size=${pageSize}`;
                if (search) {
                    url += `&search=${encodeURIComponent(search)}`;
                }
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    renderRecords(data.records || []);
                    renderPagination(data.total || 0, page);
                    document.getElementById('totalRecords').textContent = data.total || 0;
                }
            } catch (error) {
                console.error('Error loading records:', error);
            }
        }
        
        // Ê∏≤ÊüìËÆ∞ÂΩï
        function renderRecords(records) {
            const tbody = document.getElementById('recordsTable');
            const emptyState = document.getElementById('emptyState');
            
            if (records.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            tbody.innerHTML = records.map(record => `
                <tr>
                    <td class="text-muted small">${formatTime(record.timestamp)}</td>
                    <td>
                        <span class="badge-product ${record.product === 'jrebel' ? 'badge-jrebel' : 'badge-jetbrains'}">
                            ${record.product === 'jrebel' ? 'üî• JRebel' : 'üí° JetBrains'}
                        </span>
                    </td>
                    <td class="text-mono truncate" title="${record.guid || '-'}">${record.guid || '-'}</td>
                    <td>${record.username || '-'}</td>
                    <td class="text-mono">${record.ip || '-'}</td>
                    <td><span class="badge bg-light text-dark">${record.action || '-'}</span></td>
                </tr>
            `).join('');
        }
        
        // Ê∏≤ÊüìÂàÜÈ°µ
        function renderPagination(total, current) {
            const totalPages = Math.ceil(total / pageSize);
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // ‰∏ä‰∏ÄÈ°µ
            html += `
                <li class="page-item ${current === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadRecords(${current - 1}); return false;">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                </li>
            `;
            
            // È°µÁ†Å
            const startPage = Math.max(1, current - 2);
            const endPage = Math.min(totalPages, current + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                html += `
                    <li class="page-item ${i === current ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="loadRecords(${i}); return false;">${i}</a>
                    </li>
                `;
            }
            
            // ‰∏ã‰∏ÄÈ°µ
            html += `
                <li class="page-item ${current === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadRecords(${current + 1}); return false;">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
            `;
            
            pagination.innerHTML = html;
        }
        
        // ÊêúÁ¥¢
        function searchRecords() {
            const search = document.getElementById('searchInput').value.trim();
            loadRecords(1, search);
        }
        
        // Âà∑Êñ∞
        function refreshRecords() {
            document.getElementById('searchInput').value = '';
            loadStats();
            loadRecords(1);
        }
        
        // Ê†ºÂºèÂåñÊó∂Èó¥
        function formatTime(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
        
        // ÂõûËΩ¶ÊêúÁ¥¢
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchRecords();
            }
        });
        
        // ÂàùÂßãÂåñ
        checkAuth();
    </script>
</body>
</html>